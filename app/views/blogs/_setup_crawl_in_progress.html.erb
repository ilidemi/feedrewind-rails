<style>
    .progress_page {
        width: 1em;
        height: 1em;
        border-width: 1px;
        border-style: solid;
        display: inline-block;
        margin-left: 2px;
        margin-right: 2px;
    }

    .progress_long_page {
        width: calc(3em + 12px); /* include gaps and borders */
        height: 1em;
        border-width: 1px;
        border-style: solid;
        display: inline-block;
        margin-left: 2px;
        margin-right: 2px;
    }

    .progress_regular {
        background-color: silver;
        border-color: gray;
    }

    .progress_finishing {
        background-color: tomato;
        border-color: orangered;
    }

    .progress_page_remaining {
        width: 1em;
        height: 1em;
        border-width: 1px;
        border-style: solid;
        border-color: transparent;
        display: inline-block;
        background-color: whitesmoke;
        margin-left: 2px;
        margin-right: 2px;
    }
</style>

<script>
    {
        let status_epoch;
        let count_epoch;

        function createRect(classes) {
            let rect = document.createElement("div");
            rect.className = classes;
            return rect;
        }

        function displayProgress(data) {
            if (data.status && (!status_epoch || data.status_epoch > status_epoch)) {
                status_epoch = data.status_epoch;
                let rects = [];
                let tokens = [...data.status.matchAll(/p+|hF\d*|h/g)];
                for (let index in tokens) {
                    let token = tokens[index];
                    if (token[0] === "h") {
                        rects.push(createRect("progress_page progress_regular"));
                    } else if (token[0].startsWith("p")) {
                        (token[0].match(/p/g) || []).forEach(() => {
                            rects.push(createRect("progress_long_page progress_regular"));
                        });
                    } else if (token[0].startsWith("hF")) {
                        rects.push(createRect("progress_page progress_finishing"));
                        if (parseInt(index) === tokens.length - 1) {
                            let remainingCountMatch = token[0].match(/\d+$/g);
                            if (remainingCountMatch) {
                                let remainingCount = parseInt(remainingCountMatch[0]);
                                for (let i = 0; i < remainingCount; i++) {
                                    rects.push(createRect("progress_page_remaining"));
                                }
                            }
                        }
                    } else {
                        console.warn(`Unknown progress token: ${token} (${data})`);
                    }
                }
                document.getElementById("progress_rects").replaceChildren(...rects);
            }

            if (data.hasOwnProperty("count") && (!count_epoch || data.count_epoch > count_epoch)) {
                count_epoch = data.count_epoch;
                if (data.count) {
                    document.getElementById("progress_count").innerHTML = `Discovering posts: ${data.count}`;
                } else {
                    document.getElementById("progress_count").innerHTML = "Discovering posts...";
                }
            }

            if (data.done) {
                // Reload the page
                Turbolinks.visit(window.location);
            }
        }

        let subscription = window.discoverySubscribe("<%= blog.id %>", data => {
            displayProgress(data);
        });
        document.addEventListener('turbolinks:before-render', () => {
            window.discoveryUnsubscribe(subscription)
        });
    }
</script>

<div id="progress_count">
  <% unless blog.fetch_count %>
    Discovering posts...
  <% end %>
</div>
<% if blog.fetch_count %>
  <script>displayProgress({
      count: <%= blog.fetch_count %>,
      count_epoch: <%= blog.fetch_count_epoch %>
  })</script>
<% end %>
<span id="progress_rects"></span>
<% if blog.fetch_progress %>
  <script>displayProgress({
      status: "<%= blog.fetch_progress %>",
      status_epoch: <%= blog.fetch_progress_epoch %>
  })</script>
<% end %>
<br>
<br>
<%= button_to "Cancel", blog_path(blog),
              method: :delete,
              data: { confirm: "Cancel adding #{blog.name}? Progress in discovering posts will be lost." }
%>