<div>
  <%= form_with url: SubscriptionsHelper.schedule_path(subscription), method: :post do %>
    <div class="flex flex-col gap-6">
      <div>
        <%= label_tag :name, "Name", class: "font-semibold" %>
        <%= text_field_tag :name,
                           subscription.name,
                           class: "rounded-md shadow-sm border-gray-300 block w-80 mt-2" %>
        <div id="name_empty_error" class="hidden text-red-600">* Name cannot be empty</div>
      </div>

      <div>
        <%= render partial: "schedule", locals: {
          subscription_name: subscription.name,
          current_counts_by_day: days_of_week.to_h { |day| [day, 0] },
          other_sub_names_by_day: other_sub_names_by_day,
          days_of_week: days_of_week
        } %>
      </div>

      <div>
        <%= submit_tag "Continue", id: "save", class: "btn" %>
      </div>
    </div>

    <script>
        let isNameValid = true;
        let isScheduleValid = true;

        function validateForm() {
            let isFormValid = isNameValid && isScheduleValid
            let saveButton = document.getElementById("save");
            saveButton.disabled = !isFormValid;
        }

        let nameTimer;
        let nameChangeScheduleCallback = (_) => {
        };

        function setNameChangeScheduleCallback(callback) {
            nameChangeScheduleCallback = callback;
        }

        function validateName() {
            let newName = document.getElementById("name").value;
            if (newName.length === 0) {
                isNameValid = false;
                document.getElementById("name_empty_error").classList.remove("hidden");
            } else {
                isNameValid = true;
                document.getElementById("name_empty_error").classList.add("hidden");

                clearTimeout(nameTimer);
                nameTimer = setTimeout(() => {
                    document.getElementById("<%= name_header_id %>").innerText = newName;
                    nameChangeScheduleCallback(newName);
                }, 500);
            }
            validateForm();
        }

        document.getElementById("name").addEventListener("input", validateName);

        function onValidateSchedule(isValid) {
            isScheduleValid = isValid;
            validateForm();
        }
    </script>

    <%= render partial: "schedule_js", locals: {
      days_of_week: days_of_week,
      js_validate_callback: "onValidateSchedule",
      js_set_name_change_callback: "setNameChangeScheduleCallback"
    } %>
  <% end %>
</div>